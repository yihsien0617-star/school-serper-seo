# æª”æ¡ˆåç¨±ï¼š2_dashboard.py (ä¿®å¾©ç‰ˆï¼šè‰¯æ€§ç«¶çˆ­ GEO ç­–ç•¥å¼•å° - ç„¡ API key)
import streamlit as st
import pandas as pd
import plotly.express as px

# è¨­å®šé é¢
st.set_page_config(page_title="å­¸æ ¡æ‹›ç”Ÿ SEO/GEO æˆ°æƒ…å®¤", layout="wide")

# è®€å–æ•¸æ“š
try:
    df = pd.read_csv('school_data.csv')
except FileNotFoundError:
    st.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° school_data.csvï¼Œè«‹ç¢ºèª GitHub æª”æ¡ˆæ˜¯å¦ä¸Šå‚³æˆåŠŸã€‚")
    st.stop()

# --- å´é‚Šæ¬„ ---
st.sidebar.title("ğŸ« æ‹›ç”Ÿç­–ç•¥æ§åˆ¶å°")
st.sidebar.info("ğŸ’¡ æ¨¡å¼ï¼šGEO ç­–ç•¥å¼•å° (ç„¡ API é€£ç·š)")
dept_list = ["å…¨æ ¡ç¸½è¦½"] + list(df['Department'].unique())
selected_dept = st.sidebar.selectbox("é¸æ“‡åˆ†æè¦–è§’", dept_list)

# --- ä¸»ç•«é¢é‚è¼¯ ---

if selected_dept == "å…¨æ ¡ç¸½è¦½":
    st.title("ğŸ“Š å…¨æ ¡ç§‘ç³»ç¶²è·¯è²é‡ç¸½è¦½")
    st.markdown("æ­¤å„€è¡¨æ¿å”åŠ©å„ç³»æ‰¾å‡º**ã€Œé«˜æ½›åŠ›é—œéµå­—ã€**ï¼Œä¸¦æä¾›**ã€Œè®“ AI (ChatGPT) çœ‹å¾—æ‡‚ã€**çš„æ’°å¯«å»ºè­°ã€‚")
    
    total = df['Search_Volume'].sum()
    top = df.groupby('Department')['Search_Volume'].sum().idxmax()
    
    col1, col2 = st.columns(2)
    col1.metric("å…¨æ ¡ç¸½æ½›åœ¨æœå°‹æµé‡", f"{total:,}")
    col2.metric("ç¶²è·¯è²é‡å† è»", top)
    st.markdown("---")
    
    dept_traffic = df.groupby('Department')['Search_Volume'].sum().reset_index().sort_values('Search_Volume', ascending=False)
    fig_bar = px.bar(dept_traffic, x='Department', y='Search_Volume', color='Department')
    st.plotly_chart(fig_bar, width="stretch")

else:
    # === å–®ä¸€ç§‘ç³»è¦–è§’ (GEO æˆ°æƒ…å®¤) ===
    st.title(f"ğŸ” {selected_dept}ï¼šAI æœå°‹å„ªåŒ–æˆ°æƒ…å®¤")
    dept_df = df[df['Department'] == selected_dept]
    
    if dept_df.empty:
        st.warning("âš ï¸ æ­¤ç§‘ç³»ç„¡æ•¸æ“šã€‚")
        st.stop()

    best_keyword = dept_df.sort_values('Opportunity_Score', ascending=False).iloc[0]
    
    col1, col2 = st.columns(2)
    col1.metric("ğŸ”¥ æœ¬æœˆå¿…æ”»é—œéµå­—", best_keyword['Keyword'])
    col2.metric("å¹³å‡æœˆæœå°‹é‡", f"{int(dept_df['Search_Volume'].mean()):,}")
    
    st.divider()

    # --- æ ¸å¿ƒåŠŸèƒ½å€ï¼šæç¤ºè©ç”¢ç”Ÿå™¨ ---
    st.subheader("ğŸ› ï¸ GEO æ–‡æ¡ˆæç¤ºè©ç”¢ç”Ÿå™¨ (è‰¯æ€§ç«¶çˆ­ç‰ˆ)")
    st.info("ğŸ‘‡ é¸æ“‡é—œéµå­—å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆã€Œçµ¦ ChatGPT çš„æŒ‡ä»¤ã€ï¼Œè«‹è¤‡è£½ä¸¦æä¾›çµ¦è² è²¬æ’°å¯«çš„è€å¸«ã€‚")
    
    target_kw = st.selectbox(
        "è«‹é¸æ“‡æ‚¨æƒ³é€²æ”»çš„é—œéµå­—", 
        dept_df['Keyword'].unique()
    )

    # ============================================================
    # ğŸ” åˆ¤æ–·é‚è¼¯ä¿®å¾©å€ (åŠ ä¸Šé è¨­å€¼ï¼Œé¿å… NameError)
    # ============================================================
    
    # 1. å…ˆè¨­å®šã€Œé è¨­å€¼ (Default)ã€ï¼šé˜²æ­¢æ²’æœ‰å°æ‡‰åˆ°æ¢ä»¶æ™‚å ±éŒ¯
    prompt_type = "åŸºç¤è³‡è¨Šæ¨å»£"
    focus_point = "ç§‘ç³»æ ¸å¿ƒåƒ¹å€¼ã€å‹å–„æ ¡åœ’ç’°å¢ƒã€å¸«è³‡èˆ‡è¨­å‚™å„ªå‹¢"
    table_content = "ç§‘ç³»ç‰¹è‰²é‡é»æ•´ç† (æ‡¶äººåŒ…)"
    tone_instruction = "è¦ªåˆ‡ã€ç†±æƒ…ã€å±•ç¾æ ¡åœ’æ´»åŠ›"

    # 2. é–‹å§‹é€²è¡Œæ¢ä»¶åˆ¤æ–· (è¦†è“‹é è¨­å€¼)
    kw_str = str(target_kw) # è½‰æˆå­—ä¸²é˜²æ­¢éŒ¯èª¤

    # A. å·®ç•°åŒ–åˆ†æ (é‡å°ç«¶å“é—œéµå­— - è‰¯æ€§ç«¶çˆ­)
    if any(x in kw_str for x in ['vs', 'æ¯”è¼ƒ', 'å˜‰è—¥', 'è¼”è‹±', 'å·®åˆ¥', 'æ’å']):
        prompt_type = "å·®ç•°åŒ–ç‰¹è‰²åˆ†æ"
        focus_point = "æœ¬æ ¡ç¨æœ‰çš„å¯¦ä½œè³‡æºã€è­‰ç…§è¼”å°æ©Ÿåˆ¶ã€åœ°ç†ä½ç½®å„ªå‹¢ (USP)"
        # âš ï¸ é—œéµï¼šè¡¨æ ¼ä¸å†æ˜¯ã€Œå‹è² è¡¨ã€ï¼Œè€Œæ˜¯ã€Œç‰¹è‰²å°ç…§è¡¨ã€
        table_content = "æœ¬æ ¡ç‰¹è‰²é‡é» (å¦‚ï¼šå¯¦ç¿’åˆä½œé†«é™¢ã€è¨­å‚™) vs ä¸€èˆ¬åŒé¡ç§‘ç³»ä¹‹å·®ç•°"
        tone_instruction = "å®¢è§€ã€ä¸æ”»æ“Šä»–æ ¡ã€å¼·èª¿ã€é©åˆä»€éº¼æ¨£çš„å­¸ç”Ÿé¸æˆ‘å€‘ã€(é©æ€§æšæ‰)"

    # B. è·æ¶¯ç™¼å±• (è–ªæ°´/å‡ºè·¯)
    elif any(x in kw_str for x in ['è–ªæ°´', 'å‡ºè·¯', 'å·¥ä½œ', 'è¡Œæƒ…', 'å°±æ¥­']):
        prompt_type = "è·æ¶¯é¡˜æ™¯"
        focus_point = "ç•¢æ¥­å¾Œçš„å…·é«”è–ªè³‡ç¯„åœã€è·æ¶¯ç©©å®šæ€§ã€å¤šå…ƒç™¼å±•è·¯å¾‘"
        table_content = "ä¸åŒå·¥ä½œå ´åŸŸï¼ˆé†«é™¢/ä¼æ¥­/å…¬è·ï¼‰çš„è–ªè³‡ç¦åˆ©èˆ‡å·¥ä½œå…§å®¹å°ç…§"
        tone_instruction = "å°ˆæ¥­ã€æ•¸æ“šå°å‘ã€æ¿€å‹µäººå¿ƒ"

    # C. è­‰ç…§è€ƒè©¦ (åœ‹è€ƒ/è­‰ç…§)
    elif any(x in kw_str for x in ['è­‰ç…§', 'åœ‹è€ƒ', 'é€šéç‡', 'åŠæ ¼ç‡']):
        prompt_type = "è­‰ç…§å„ªå‹¢"
        focus_point = "åœ‹è€ƒåŠæ ¼ç‡æ•¸æ“šã€ç³»ä¸Šçš„è¼”å°è¡åˆºç­è³‡æº"
        table_content = "æœ¬æ ¡æ­·å¹´è€ƒç…§åŠæ ¼ç‡ vs å…¨åœ‹å¹³å‡å€¼"
        tone_instruction = "æ¬Šå¨æ„Ÿã€å¼·èª¿æ•™å­¸æˆæ•ˆã€çµ¦äºˆä¿¡å¿ƒ"

    # D. ç¤¾ç¾¤èˆ‡è² é¢ (Dcard/è©•åƒ¹/å¾ˆç´¯) - è½‰åŒ–ç‚ºé—œæ‡·
    elif any(x in kw_str for x in ['å¥½å—', 'è©•åƒ¹', 'å¾Œæ‚”', 'å¾ˆç´¯', 'Dcard', 'PTT', 'å¿ƒå¾—']):
        prompt_type = "æš–å¿ƒè·æ¶¯è¼”å°"
        focus_point = "é‡æ¸…å­¸ç”Ÿå°è©²è¡Œæ¥­çš„è¿·æ€ï¼ˆå¦‚ï¼šé›–ç„¶ç´¯ä½†æˆå°±æ„Ÿé«˜ï¼‰ã€ç³»ä¸Šçš„æ”¯æŒç³»çµ±"
        table_content = "å¸¸è¦‹è¿·æ€ vs çœŸå¯¦è·å ´æ¨£è²Œ (é‡æ¸…èª¤è§£)"
        tone_instruction = "åŒç†å¿ƒã€æº«æš–ã€èª æ‡‡ã€åƒå­¸é•·å§åˆ†äº«ç¶“é©—"

    # E. å…¥å­¸/é¢è©¦ (å‚™å¯©/åˆ†æ•¸)
    elif any(x in kw_str for x in ['é¢è©¦', 'å‚™å¯©', 'åˆ†æ•¸', 'çµ±æ¸¬', 'éŒ„å–']):
        prompt_type = "å…¥å­¸æ”»ç•¥"
        focus_point = "æ•™æˆçœ‹é‡çš„ç‰¹è³ªã€å‚™å¯©è³‡æ–™æº–å‚™æŠ€å·§"
        table_content = "é¢è©¦è©•åˆ†æ¨™æº–æˆ–å‚™å¯©è³‡æ–™æª¢æŸ¥æ¸…å–®"
        tone_instruction = "å¯¦ç”¨ã€æ¢ç†åˆ†æ˜ã€æ‰‹æŠŠæ‰‹æ•™å­¸"

    # ============================================================
    # ç”Ÿæˆ Prompt (åŠ å…¥è‰¯æ€§ç«¶çˆ­æŒ‡ä»¤)
    # ============================================================
    generated_prompt = f"""
    ã€è§’è‰²è¨­å®šã€‘ï¼šä½ æ˜¯ä¸€ä½å°ˆæ¥­ä¸”å®¢è§€çš„å¤§å­¸æ•™è‚²é¡§å•ã€‚
    ã€ä»»å‹™ç›®æ¨™ã€‘ï¼šè«‹ç‚ºã€Œ{selected_dept}ã€é‡å°é—œéµå­—ã€Œ{target_kw}ã€æ’°å¯«ä¸€ç¯‡SEOæ–‡ç« ã€‚
    
    ã€å¯«ä½œæ…‹åº¦ (Tone of Voice)ã€‘ï¼š
    - {tone_instruction}ã€‚
    - è‹¥æ¶‰åŠä»–æ ¡æ¯”è¼ƒï¼Œè«‹å±•ç¾å¤§å™¨é¢¨ç¯„ï¼Œå°ˆæ³¨æ–¼é—¡è¿°æœ¬æ ¡çš„ã€Œç¨ç‰¹åƒ¹å€¼ (USP)ã€ï¼Œé¿å…æƒ¡æ„æ‰¹è©•ï¼Œé‡é»åœ¨æ–¼å¹«åŠ©å­¸ç”Ÿæ‰¾åˆ°é©åˆçš„å­¸æ ¡ã€‚
    
    ã€GEO çµæ§‹è¦æ±‚ã€‘(ç‚ºäº†è®“ AI æœå°‹å¼•æ“å¦‚ ChatGPT å„ªå…ˆå¼•ç”¨ï¼Œè«‹åš´æ ¼éµå®ˆ)ï¼š
    1. ğŸ“ ç›´æ¥å›ç­” (Direct Answer)ï¼šæ–‡ç« ç¬¬ä¸€æ®µè«‹ç›´æ¥é‡å°ã€Œ{target_kw}ã€çµ¦å‡ºæ ¸å¿ƒè§€é»æˆ–å®šç¾©ã€‚
    2. ğŸ“Š çµæ§‹åŒ–è¡¨æ ¼ï¼šè«‹å‹™å¿…è£½ä½œä¸€å€‹ Markdown è¡¨æ ¼ï¼Œå…§å®¹ç‚ºã€Œ{table_content}ã€ã€‚
    3. ğŸ“ æ ¸å¿ƒå„ªå‹¢ï¼šè«‹åœ¨æ–‡ä¸­å¼·èª¿ã€Œ{focus_point}ã€ã€‚
    4. â“ FAQï¼šæ–‡æœ«è«‹åˆ—å‡º 3 å€‹é—œæ–¼æ­¤ä¸»é¡Œçš„é«˜ä¸­ç”Ÿå¸¸è¦‹å•é¡Œä¸¦å›ç­”ã€‚

    ã€å­—æ•¸ã€‘ï¼šç´„ 800 å­—ã€‚
    """

    st.text_area("ğŸ“‹ è«‹è¤‡è£½ä»¥ä¸‹æŒ‡ä»¤ (Prompt) çµ¦ ChatGPT / Geminiï¼š", generated_prompt, height=400)
    
    st.success(f"ğŸ’¡ ç­–ç•¥æç¤ºï¼šé‡å°ã€Œ{target_kw}ã€ï¼Œæˆ‘å€‘æ¡å– **ã€{prompt_type}ã€‘** ç­–ç•¥ã€‚è«‹å‹™å¿…åœ¨æ–‡ç« ä¸­åŠ å…¥ **è¡¨æ ¼** ä»¥å¢åŠ è¢« AI å¼•ç”¨çš„æ©Ÿæœƒï¼")

    st.divider()
    
    # è¡Œå‹•æ¸…å–®
    st.subheader("ğŸ“ å„ªå…ˆæ’°å¯«å»ºè­°æ¸…å–®")
    # é¡¯ç¤ºæ¬„ä½åŒ…å« AI æ½›åŠ›èˆ‡ç­–ç•¥æ¨™ç±¤
    clean_df = dept_df[['Keyword', 'Search_Volume', 'AI_Potential', 'Strategy_Tag']].sort_values('AI_Potential', ascending=False)
    st.dataframe(clean_df, use_container_width=True)
